name: Upstream Triage

on:
  schedule:
    - cron: '0 8 * * 1'   # Monday 08:00 UTC
  workflow_dispatch:
    inputs:
      apply:
        description: "Create cherry-pick topic branches"
        type: boolean
        default: false
      open_pr:
        description: "Open PRs for topic branches (requires apply)"
        type: boolean
        default: false
      ai_triage:
        description: "Use Claude CLI for semantic classification"
        type: boolean
        default: false

# --------------------------------------------------------------------------
# Job: report — read-only scan, artifact upload, issue creation
# Job: apply  — cherry-pick branches + PRs (manual dispatch only, write perms)
# --------------------------------------------------------------------------

jobs:
  report:
    name: Scan upstream candidates
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: daisy/dev

      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/moltbot/moltbot.git || true
          git fetch upstream --quiet

      - name: Install Claude CLI
        if: github.event_name == 'workflow_dispatch' && inputs.ai_triage
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [[ -z "${ANTHROPIC_API_KEY}" ]]; then
            echo "::warning::ANTHROPIC_API_KEY not set; AI triage will fall back to heuristic"
          else
            npm install -g @anthropic-ai/claude-code || echo "::warning::Failed to install Claude CLI; falling back to heuristic"
          fi

      - name: Run upstream triage (report only)
        id: triage
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          chmod +x scripts/upstream-triage.sh
          ARGS=()

          if [[ "${{ github.event_name }}" != "schedule" ]]; then
            # Manual dispatch: read inputs (report-only, no --apply/--open-pr)
            if [[ "${{ inputs.ai_triage }}" == "true" ]]; then
              ARGS+=("--ai-triage")
            fi
          fi

          echo "Running: scripts/upstream-triage.sh ${ARGS[*]}"
          scripts/upstream-triage.sh "${ARGS[@]}"

          # Capture report path for subsequent steps
          REPORT="docs/upstream-candidates/$(date +%Y-%m-%d).md"
          if [[ -f "${REPORT}" ]]; then
            echo "report_path=${REPORT}" >> "$GITHUB_OUTPUT"
            echo "has_report=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_report=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload triage report
        if: steps.triage.outputs.has_report == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: upstream-triage-report
          path: docs/upstream-candidates/
          retention-days: 90

      - name: Create summary issue (scheduled runs)
        if: github.event_name == 'schedule' && steps.triage.outputs.has_report == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REPORT="${{ steps.triage.outputs.report_path }}"
          TODAY="$(date +%Y-%m-%d)"

          # Truncate report for issue body (GitHub has a 65536 char limit)
          BODY="$(head -c 60000 "${REPORT}")"
          FOOTER=$'\n---\nFull report available as workflow artifact.\nNo upstream code was executed to produce this report.'

          gh issue create \
            --title "Upstream triage: ${TODAY}" \
            --body "${BODY}${FOOTER}" \
            --label "upstream,triage" || echo "::warning::Failed to create issue (labels may not exist)"

  apply:
    name: Create cherry-pick branches + PRs
    if: github.event_name == 'workflow_dispatch' && inputs.apply
    needs: report
    runs-on: ubuntu-latest
    environment: staging

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: daisy/dev
          token: ${{ secrets.UPSYNC_PAT }}

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/moltbot/moltbot.git || true
          git fetch upstream --quiet

      - name: Install Claude CLI
        if: inputs.ai_triage
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [[ -z "${ANTHROPIC_API_KEY}" ]]; then
            echo "::warning::ANTHROPIC_API_KEY not set; AI triage will fall back to heuristic"
          else
            npm install -g @anthropic-ai/claude-code || echo "::warning::Failed to install Claude CLI; falling back to heuristic"
          fi

      - name: Run upstream triage (apply + PR)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          chmod +x scripts/upstream-triage.sh
          ARGS=(--apply)

          if [[ "${{ inputs.ai_triage }}" == "true" ]]; then
            ARGS+=("--ai-triage")
          fi
          if [[ "${{ inputs.open_pr }}" == "true" ]]; then
            ARGS+=("--open-pr")
          fi

          echo "Running: scripts/upstream-triage.sh ${ARGS[*]}"
          scripts/upstream-triage.sh "${ARGS[@]}"
