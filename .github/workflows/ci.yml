name: CI

on:
  push:
    branches:
      - daisy/main
      - daisy/dev
  pull_request:
    branches:
      - daisy/main
      - daisy/dev
  workflow_dispatch:
    inputs:
      run_ios:
        description: Run iOS tests
        type: boolean
        default: false
concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  a2ui-bundle:
    name: A2UI bundle prep
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.bundle-meta.outputs.artifact_name }}
      bundle-seconds: ${{ steps.bundle-meta.outputs.bundle_seconds }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      # pnpm must be on PATH before setup-node so cache: 'pnpm' can
      # resolve the store path for cache keys.
      - name: Setup pnpm (corepack)
        run: |
          corepack enable
          for attempt in 1 2 3; do
            if corepack prepare pnpm@10.23.0 --activate; then
              pnpm -v
              break
            fi
            echo "corepack prepare failed (attempt $attempt/3). Retrying..."
            sleep $((attempt * 5))
          done

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.14.0
          cache: 'pnpm'

      - name: Install dependencies
        env:
          CI: true
        run: |
          install_flags="--frozen-lockfile --ignore-scripts=false --config.engine-strict=false --config.enable-pre-post-scripts=true"
          for attempt in 1 2 3; do
            echo "pnpm install attempt ${attempt}/3"
            if pnpm install ${install_flags}; then
              echo "pnpm install succeeded on attempt ${attempt}/3"
              break
            fi
            if [ "${attempt}" -eq 3 ]; then
              echo "pnpm install failed after ${attempt}/3 attempts"
              exit 1
            fi
            echo "pnpm install failed (attempt ${attempt}/3). Retrying..."
            sleep $((attempt * 5))
          done

      - name: Build A2UI bundle
        id: bundle-meta
        run: |
          start_epoch="$(date +%s)"
          pnpm canvas:a2ui:bundle
          end_epoch="$(date +%s)"
          bundle_seconds="$((end_epoch - start_epoch))"
          artifact_name="a2ui-bundle-${{ github.sha }}-${{ github.run_id }}-${{ github.job }}"
          echo "bundle_seconds=${bundle_seconds}" >> "$GITHUB_OUTPUT"
          echo "artifact_name=${artifact_name}" >> "$GITHUB_OUTPUT"

      - name: Ensure A2UI bundle hash exists
        run: |
          if [ ! -s src/canvas-host/a2ui/.bundle.hash ]; then
            sha256sum src/canvas-host/a2ui/a2ui.bundle.js | awk '{print $1}' > src/canvas-host/a2ui/.bundle.hash
          fi

      - name: Verify A2UI bundle outputs
        run: |
          test -s src/canvas-host/a2ui/a2ui.bundle.js
          test -s src/canvas-host/a2ui/.bundle.hash

      - name: Upload A2UI bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.bundle-meta.outputs.artifact_name }}
          include-hidden-files: true
          path: |
            src/canvas-host/a2ui/a2ui.bundle.js
            src/canvas-host/a2ui/.bundle.hash

  checks:
    name: Linux / ${{ matrix.task }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - task: lint
            command: pnpm lint
          - task: build
            command: pnpm build
          - task: protocol
            command: pnpm protocol:check
          - task: format
            command: pnpm format
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      # pnpm must be on PATH before setup-node so cache: 'pnpm' can
      # resolve the store path for cache keys.
      - name: Setup pnpm (corepack)
        run: |
          corepack enable
          for attempt in 1 2 3; do
            if corepack prepare pnpm@10.23.0 --activate; then
              pnpm -v
              break
            fi
            echo "corepack prepare failed (attempt $attempt/3). Retrying..."
            sleep $((attempt * 5))
          done

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.14.0
          cache: 'pnpm'

      - name: Runtime versions
        run: |
          node -v
          npm -v
          pnpm -v

      - name: Install dependencies
        env:
          CI: true
        run: |
          install_flags="--frozen-lockfile --ignore-scripts=false --config.engine-strict=false --config.enable-pre-post-scripts=true"
          for attempt in 1 2 3; do
            echo "pnpm install attempt ${attempt}/3"
            if pnpm install ${install_flags}; then
              echo "pnpm install succeeded on attempt ${attempt}/3"
              break
            fi
            if [ "${attempt}" -eq 3 ]; then
              echo "pnpm install failed after ${attempt}/3 attempts"
              exit 1
            fi
            echo "pnpm install failed (attempt ${attempt}/3). Retrying..."
            sleep $((attempt * 5))
          done

      - name: Run ${{ matrix.task }}
        run: ${{ matrix.command }}

  secrets:
    name: Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install detect-secrets
        run: |
          python -m pip install --upgrade pip
          python -m pip install detect-secrets==1.5.0

      - name: Detect secrets
        run: |
          if ! detect-secrets scan --baseline .secrets.baseline; then
            echo "::error::Secret scanning failed. See docs/gateway/security.md#secret-scanning-detect-secrets"
            exit 1
          fi

  checks-windows:
    name: Windows / ${{ matrix.runtime }} / ${{ matrix.task }}
    runs-on: windows-latest
    env:
      NODE_OPTIONS: --max-old-space-size=4096
      CLAWDBOT_TEST_WORKERS: 1
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - runtime: node
            task: lint
            command: pnpm lint
          - runtime: node
            task: build
            command: pnpm build
          - runtime: node
            task: protocol
            command: pnpm protocol:check
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      # pnpm must be on PATH before setup-node so cache: 'pnpm' can
      # resolve the store path for cache keys.
      - name: Setup pnpm (corepack)
        run: |
          corepack enable
          for attempt in 1 2 3; do
            if corepack prepare pnpm@10.23.0 --activate; then
              pnpm -v
              break
            fi
            echo "corepack prepare failed (attempt $attempt/3). Retrying..."
            sleep $((attempt * 5))
          done

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.14.0
          cache: 'pnpm'

      - name: Runtime versions
        run: |
          node -v
          npm -v
          pnpm -v

      - name: Install dependencies
        env:
          CI: true
        run: |
          install_flags="--frozen-lockfile --ignore-scripts=false --config.engine-strict=false --config.enable-pre-post-scripts=true"
          for attempt in 1 2 3; do
            echo "pnpm install attempt ${attempt}/3"
            if pnpm install ${install_flags}; then
              echo "pnpm install succeeded on attempt ${attempt}/3"
              break
            fi
            if [ "${attempt}" -eq 3 ]; then
              echo "pnpm install failed after ${attempt}/3 attempts"
              exit 1
            fi
            echo "pnpm install failed (attempt ${attempt}/3). Retrying..."
            sleep $((attempt * 5))
          done

      - name: Run ${{ matrix.task }} (${{ matrix.runtime }})
        run: ${{ matrix.command }}

  checks-linux-test:
    name: Linux / test
    needs: a2ui-bundle
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      # pnpm must be on PATH before setup-node so cache: 'pnpm' can
      # resolve the store path for cache keys.
      - name: Setup pnpm (corepack)
        run: |
          corepack enable
          for attempt in 1 2 3; do
            if corepack prepare pnpm@10.23.0 --activate; then
              pnpm -v
              break
            fi
            echo "corepack prepare failed (attempt $attempt/3). Retrying..."
            sleep $((attempt * 5))
          done

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.14.0
          cache: 'pnpm'

      - name: Runtime versions
        run: |
          node -v
          npm -v
          pnpm -v

      - name: Install dependencies
        env:
          CI: true
        run: |
          install_flags="--frozen-lockfile --ignore-scripts=false --config.engine-strict=false --config.enable-pre-post-scripts=true"
          for attempt in 1 2 3; do
            echo "pnpm install attempt ${attempt}/3"
            if pnpm install ${install_flags}; then
              echo "pnpm install succeeded on attempt ${attempt}/3"
              break
            fi
            if [ "${attempt}" -eq 3 ]; then
              echo "pnpm install failed after ${attempt}/3 attempts"
              exit 1
            fi
            echo "pnpm install failed (attempt ${attempt}/3). Retrying..."
            sleep $((attempt * 5))
          done

      - name: Download A2UI bundle artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.a2ui-bundle.outputs.artifact-name }}
          path: .

      - name: Verify A2UI bundle outputs
        run: |
          test -s src/canvas-host/a2ui/a2ui.bundle.js
          test -s src/canvas-host/a2ui/.bundle.hash

      - name: Run test
        run: pnpm test -- --no-file-parallelism

  checks-windows-test:
    name: Windows / node / test
    needs: a2ui-bundle
    runs-on: windows-latest
    env:
      NODE_OPTIONS: --max-old-space-size=4096
      CLAWDBOT_TEST_WORKERS: 1
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      # pnpm must be on PATH before setup-node so cache: 'pnpm' can
      # resolve the store path for cache keys.
      - name: Setup pnpm (corepack)
        run: |
          corepack enable
          for attempt in 1 2 3; do
            if corepack prepare pnpm@10.23.0 --activate; then
              pnpm -v
              break
            fi
            echo "corepack prepare failed (attempt $attempt/3). Retrying..."
            sleep $((attempt * 5))
          done

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.14.0
          cache: 'pnpm'

      - name: Runtime versions
        run: |
          node -v
          npm -v
          pnpm -v

      - name: Install dependencies
        env:
          CI: true
        run: |
          install_flags="--frozen-lockfile --ignore-scripts=false --config.engine-strict=false --config.enable-pre-post-scripts=true"
          for attempt in 1 2 3; do
            echo "pnpm install attempt ${attempt}/3"
            if pnpm install ${install_flags}; then
              echo "pnpm install succeeded on attempt ${attempt}/3"
              break
            fi
            if [ "${attempt}" -eq 3 ]; then
              echo "pnpm install failed after ${attempt}/3 attempts"
              exit 1
            fi
            echo "pnpm install failed (attempt ${attempt}/3). Retrying..."
            sleep $((attempt * 5))
          done

      - name: Mark A2UI artifact download start
        run: date +%s > .a2ui-artifact-download-start

      - name: Download A2UI bundle artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.a2ui-bundle.outputs.artifact-name }}
          path: .

      - name: Capture A2UI artifact download timing
        id: artifact-transfer
        run: |
          transfer_end_epoch="$(date +%s)"
          transfer_start_epoch="$(cat .a2ui-artifact-download-start)"
          transfer_seconds="$((transfer_end_epoch - transfer_start_epoch))"
          echo "transfer_seconds=${transfer_seconds}" >> "$GITHUB_OUTPUT"

      - name: Verify A2UI bundle outputs
        run: |
          test -s src/canvas-host/a2ui/a2ui.bundle.js
          test -s src/canvas-host/a2ui/.bundle.hash

      - name: Compare bundle transfer vs rebuild timing
        run: |
          transfer_seconds="${{ steps.artifact-transfer.outputs.transfer_seconds }}"
          bundle_seconds="${{ needs.a2ui-bundle.outputs.bundle-seconds }}"
          {
            echo "### A2UI bundle strategy"
            echo "- prep build time (linux): ${bundle_seconds}s"
            echo "- artifact transfer time (windows): ${transfer_seconds}s"
            if [ "${transfer_seconds}" -le "${bundle_seconds}" ]; then
              echo "- selected path: artifact transfer (faster/equal and stable)"
            else
              echo "- selected path: artifact transfer (slower than rebuild prep; retained for now to avoid duplicate rebuild work across jobs)"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Run test
        run: pnpm test -- --no-file-parallelism


  checks-macos:
    name: macOS / node / test
    if: github.event_name == 'pull_request'
    runs-on: macos-latest
    needs: a2ui-bundle
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      # pnpm must be on PATH before setup-node so cache: 'pnpm' can
      # resolve the store path for cache keys.
      - name: Setup pnpm (corepack)
        run: |
          corepack enable
          for attempt in 1 2 3; do
            if corepack prepare pnpm@10.23.0 --activate; then
              pnpm -v
              break
            fi
            echo "corepack prepare failed (attempt $attempt/3). Retrying..."
            sleep $((attempt * 5))
          done

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.14.0
          cache: 'pnpm'

      - name: Runtime versions
        run: |
          node -v
          npm -v
          pnpm -v

      - name: Install dependencies
        env:
          CI: true
        run: |
          install_flags="--frozen-lockfile --ignore-scripts=false --config.engine-strict=false --config.enable-pre-post-scripts=true"
          for attempt in 1 2 3; do
            echo "pnpm install attempt ${attempt}/3"
            if pnpm install ${install_flags}; then
              echo "pnpm install succeeded on attempt ${attempt}/3"
              break
            fi
            if [ "${attempt}" -eq 3 ]; then
              echo "pnpm install failed after ${attempt}/3 attempts"
              exit 1
            fi
            echo "pnpm install failed (attempt ${attempt}/3). Retrying..."
            sleep $((attempt * 5))
          done

      - name: Download A2UI bundle artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.a2ui-bundle.outputs.artifact-name }}
          path: .

      - name: Verify A2UI bundle outputs
        run: |
          test -s src/canvas-host/a2ui/a2ui.bundle.js
          test -s src/canvas-host/a2ui/.bundle.hash

      - name: Run test
        env:
          NODE_OPTIONS: --max-old-space-size=4096
        run: pnpm test -- --no-file-parallelism

  macos-app:
    name: macOS App / ${{ matrix.task }}
    if: github.event_name == 'pull_request'
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - task: lint
            command: |
              swiftlint --config .swiftlint.yml
              swiftformat --lint apps/macos/Sources --config .swiftformat
          - task: build
            command: |
              set -euo pipefail
              for attempt in 1 2 3; do
                if swift build --package-path apps/macos --configuration release; then
                  exit 0
                fi
                echo "swift build failed (attempt $attempt/3). Retrying…"
                sleep $((attempt * 20))
              done
              exit 1
          - task: test
            command: |
              set -euo pipefail
              for attempt in 1 2 3; do
                if swift test --package-path apps/macos --parallel --enable-code-coverage --show-codecov-path; then
                  exit 0
                fi
                echo "swift test failed (attempt $attempt/3). Retrying…"
                sleep $((attempt * 20))
              done
              exit 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Select latest stable Xcode
        run: |
          LATEST=$(ls -d /Applications/Xcode_*.app 2>/dev/null | sort -V | tail -1)
          if [ -n "$LATEST" ]; then
            sudo xcode-select -s "$LATEST"
          fi
          xcodebuild -version

      - name: Install XcodeGen / SwiftLint / SwiftFormat
        run: |
          brew install xcodegen swiftlint swiftformat

      - name: Show toolchain
        run: |
          sw_vers
          xcodebuild -version
          swift --version

      - name: Run ${{ matrix.task }}
        run: ${{ matrix.command }}
  ios:
    name: iOS
    if: ${{ github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.run_ios) }}
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Select latest stable Xcode
        run: |
          LATEST=$(ls -d /Applications/Xcode_*.app 2>/dev/null | sort -V | tail -1)
          if [ -n "$LATEST" ]; then
            sudo xcode-select -s "$LATEST"
          fi
          xcodebuild -version

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Install SwiftLint / SwiftFormat
        run: brew install swiftlint swiftformat

      - name: Show toolchain
        run: |
          sw_vers
          xcodebuild -version
          swift --version

      - name: Generate iOS project
        run: |
          cd apps/ios
          xcodegen generate

      - name: iOS tests
        run: |
          set -euo pipefail
          RESULT_BUNDLE_PATH="$RUNNER_TEMP/Moltbot-iOS.xcresult"
          DEST_ID="$(
            python3 - <<'PY'
          import json
          import subprocess
          import sys
          import uuid

          def sh(args: list[str]) -> str:
            return subprocess.check_output(args, text=True).strip()

          # Prefer an already-created iPhone simulator if it exists.
          devices = json.loads(sh(["xcrun", "simctl", "list", "devices", "-j"]))
          candidates: list[tuple[str, str]] = []
          for runtime, devs in (devices.get("devices") or {}).items():
            for dev in devs or []:
              if not dev.get("isAvailable"):
                continue
              name = str(dev.get("name") or "")
              udid = str(dev.get("udid") or "")
              if not udid or not name.startswith("iPhone"):
                continue
              candidates.append((name, udid))

          candidates.sort(key=lambda it: (0 if "iPhone 16" in it[0] else 1, it[0]))
          if candidates:
            print(candidates[0][1])
            sys.exit(0)

          # Otherwise, create one from the newest available iOS runtime.
          runtimes = json.loads(sh(["xcrun", "simctl", "list", "runtimes", "-j"])).get("runtimes") or []
          ios = [rt for rt in runtimes if rt.get("platform") == "iOS" and rt.get("isAvailable")]
          if not ios:
            print("No available iOS runtimes found.", file=sys.stderr)
            sys.exit(1)

          def version_key(rt: dict) -> tuple[int, ...]:
            parts: list[int] = []
            for p in str(rt.get("version") or "0").split("."):
              try:
                parts.append(int(p))
              except ValueError:
                parts.append(0)
            return tuple(parts)

          ios.sort(key=version_key, reverse=True)
          runtime = ios[0]
          runtime_id = str(runtime.get("identifier") or "")
          if not runtime_id:
            print("Missing iOS runtime identifier.", file=sys.stderr)
            sys.exit(1)

          supported = runtime.get("supportedDeviceTypes") or []
          iphones = [dt for dt in supported if dt.get("productFamily") == "iPhone"]
          if not iphones:
            print("No iPhone device types for iOS runtime.", file=sys.stderr)
            sys.exit(1)

          iphones.sort(
            key=lambda dt: (
              0 if "iPhone 16" in str(dt.get("name") or "") else 1,
              str(dt.get("name") or ""),
            )
          )
          device_type_id = str(iphones[0].get("identifier") or "")
          if not device_type_id:
            print("Missing iPhone device type identifier.", file=sys.stderr)
            sys.exit(1)

          sim_name = f"CI iPhone {uuid.uuid4().hex[:8]}"
          udid = sh(["xcrun", "simctl", "create", sim_name, device_type_id, runtime_id])
          if not udid:
            print("Failed to create iPhone simulator.", file=sys.stderr)
            sys.exit(1)
          print(udid)
          PY
          )"
          echo "Using iOS Simulator id: $DEST_ID"
          xcodebuild test \
            -project apps/ios/Moltbot.xcodeproj \
            -scheme Moltbot \
            -destination "platform=iOS Simulator,id=$DEST_ID" \
            -resultBundlePath "$RESULT_BUNDLE_PATH" \
            -enableCodeCoverage YES

      - name: iOS coverage summary
        run: |
          set -euo pipefail
          RESULT_BUNDLE_PATH="$RUNNER_TEMP/Moltbot-iOS.xcresult"
          xcrun xccov view --report --only-targets "$RESULT_BUNDLE_PATH"

      - name: iOS coverage gate (43%)
        run: |
          set -euo pipefail
          RESULT_BUNDLE_PATH="$RUNNER_TEMP/Moltbot-iOS.xcresult"
          RESULT_BUNDLE_PATH="$RESULT_BUNDLE_PATH" python3 - <<'PY'
          import json
          import os
          import subprocess
          import sys

          target_name = "Moltbot.app"
          minimum = 0.43

          report = json.loads(
            subprocess.check_output(
              ["xcrun", "xccov", "view", "--report", "--json", os.environ["RESULT_BUNDLE_PATH"]],
              text=True,
            )
          )

          target_coverage = None
          for target in report.get("targets", []):
            if target.get("name") == target_name:
              target_coverage = float(target["lineCoverage"])
              break

          if target_coverage is None:
            print(f"Could not find coverage for target: {target_name}")
            sys.exit(1)

          print(f"{target_name} line coverage: {target_coverage * 100:.2f}% (min {minimum * 100:.2f}%)")
          if target_coverage + 1e-12 < minimum:
            sys.exit(1)
          PY

  android:
    name: Android / ${{ matrix.task }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - task: test
            command: ./gradlew --no-daemon :app:testDebugUnitTest
          - task: build
            command: ./gradlew --no-daemon :app:assembleDebug
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: false

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: 8.11.1

      - name: Install Android SDK packages
        run: |
          yes | sdkmanager --licenses >/dev/null
          sdkmanager --install \
            "platform-tools" \
            "platforms;android-36" \
            "build-tools;36.0.0"

      - name: Run Android ${{ matrix.task }}
        working-directory: apps/android
        run: ${{ matrix.command }}
