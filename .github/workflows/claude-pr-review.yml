name: Claude PR Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: claude-pr-review-${{ github.event_name }}-${{ github.event.issue.number || github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  claude_review:
    # Only run when:
    # - issue_comment is on a PR (not an issue)
    # - OR it is a PR diff comment event
    # - AND the comment contains '@claude' and 'review'
    # - AND the commenter is trusted (OWNER/MEMBER/COLLABORATOR)
    # - AND the commenter is not a bot
    if: >
      (
        github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        contains(github.event.comment.body, '@claude') &&
        contains(toLower(github.event.comment.body), 'review')
      ) || (
        github.event_name == 'pull_request_review_comment' &&
        contains(github.event.comment.body, '@claude') &&
        contains(toLower(github.event.comment.body), 'review')
      )
    runs-on: ubuntu-latest

    steps:
      - name: Guard - trusted actor only
        if: >
          !(
            github.actor == 'github-actions[bot]' ||
            endsWith(github.actor, '[bot]')
          ) && (
            github.event.comment.author_association == 'OWNER' ||
            github.event.comment.author_association == 'MEMBER' ||
            github.event.comment.author_association == 'COLLABORATOR'
          )
        run: echo "Actor is trusted."

      - name: Block - untrusted actor
        if: >
          (
            github.actor == 'github-actions[bot]' ||
            endsWith(github.actor, '[bot]') ||
            !(
              github.event.comment.author_association == 'OWNER' ||
              github.event.comment.author_association == 'MEMBER' ||
              github.event.comment.author_association == 'COLLABORATOR'
            )
          )
        run: |
          echo "Not running Claude review: actor is untrusted or a bot."
          exit 0

      - name: Claude Code Action
        # Pin this action to a full commit SHA per our 7e policy (do not leave @v1).
        # anthropics/claude-code-action@v1
        uses: anthropics/claude-code-action@<PINNED_SHA>
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # Prefer explicit command to keep it consistent and bounded:
          prompt: "/review"
          # Keep reviews bounded and cost-controlled:
          claude_args: "--max-turns 5"
